---
title: "Reshaping Python pandas dataframe from wide to long with pd.melt"
description: |
  Learn and visualize how pd.melt reshapes data from wide to long form
author:
  - name: Hause Lin
    url: {}
date: 05-14-2020
draft: true
preview: ./main_wide2long.png
categories: 
  - python
  - pandas
output:
  radix::radix_article:
    toc: true
    self_contained: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = FALSE, comment = NA, message = FALSE, warning = FALSE)
```

Get source code for this RMarkdown script [here](https://github.com/hauselin/rtutorialsite/blob/master/_posts/2019-12-20-numpy-reshape/numpy-reshape.Rmd).

This Python tutorial is also available on [Medium, Towards Data Science](https://towardsdatascience.com/reshape-pandas-dataframe-with-melt-in-python-tutorial-and-visualization-29ec1450bb02). Click here if you're looking for the R version of melt (also the `melt` function in R).

## Consider being a patron and supporting my work?

[Donate and become a patron](https://donorbox.org/support-my-teaching): If you find value in what I do and have learned something from my site, please consider becoming a patron. It takes me many hours to research, learn, and put together tutorials. Your support really matters.

How does the pandas `melt()` method reshape dataframes? How do you reshape a dataframe from wide to long form? This tutorial will walk you through reshaping dataframes using `pd.melt()` or the `melt` method associated with pandas dataframes.

![Summary of how pd.melt() works](./main_wide2long.png)

Also, you might want to check out the official pandas documentation and my [numpy reshape tutorial](https://towardsdatascience.com/reshape-pandas-dataframe-with-melt-in-python-tutorial-and-visualization-29ec1450bb02).

Let's load the `reticulate` library in R so we can run Python in RStudio. I'll then load my conda python environment. I highly recommend you try the code in Python while you read this article. Try running this tutorial on my shared [DeepNote notebook](https://beta.deepnote.com/project/d1350ad6-bcb4-4c3d-857b-c29d01b8a803) (you can only run but not edit this notebook).

```{r}
library(reticulate)
# load conda python environment
use_condaenv(condaenv = "python376", conda = "/opt/anaconda3/bin/conda")
```

```{python}
import pandas as pd
```

## Wide data

It’s easiest to understand what a **wide** dataframe is or looks like if we look at one and compare it with a long dataframe.

![Wide pandas dataframe can be melted/stacked using pd.melt()](./pic1.png)

And below is the corresponding dataframe (with the same information) but in the **long** form:

![Wide pandas dataframe can be melted/stacked using pd.melt()](./pic2.png)

Let's create the **wide** dataset.

```{python}
df_wide = pd.DataFrame(
  {"student": ["Andy", "Bernie", "Cindy", "Deb"],
   "school":  ["Z", "Y", "Z", "Y"],
   "english": [10, 100, 1000, 10000],  # eng grades
   "math":    [20, 200, 2000, 20000],  # math grades
   "physics": [30, 300, 3000, 30000]   # physics grades
  }
)
df_wide
```

## Wide to long with `melt`

Common terms for this transformation are melt, unpivot, gather, stack. See `pd.melt()` documentation [here](https://pandas.pydata.org/docs/reference/api/pandas.melt.html).

### Melt Example 1

```{python}
pd.melt(frame=df_wide, id_vars=["student", "school"], var_name="cLaSs", value_name="gRaDe")

# or you can use the melt method associated with a dataframe
# df_wide.melt(id_vars=["student", "school"], var_name="cLaSs", value_name="gRaDe")
```

### Melt Example 2

Melt the dataframe (note `school` and `physics` columns aren't specified anywhere):

```{python}
pd.melt(frame=df_wide, id_vars="student", value_vars=["english","math"], var_name="cLaSs", value_name="gRaDe")

# or you can use the melt method associated with a dataframe
# df_wide.melt(id_vars="student", value_vars=["english","math"], var_name="cLaSs", value_name="gRaDe")
```

What happened here? We stacked/melted the `english` and `math` columns.

* `id_vars`: we specify the identifier column as the `student` column (ignoring the other identifier column `school`) 
* `value_vars`: we melt only two columns, `english` and `math` (ignoring `physics`)
* `var_name`: we specify a new column name to represent `value_vars`
* `value_name`: we specify a new column name to represent the contents in `value_vars`

### Melt Example 3

If we leave out the `value_vars` parameter, all columns not in `id_vars` will be stacked/melted. In this case, all columns (from `school` to `physics`) will be melted into a single column.

```{python}
pd.melt(frame=df_wide, id_vars="student", var_name="cLaSs", value_name="gRaDe")

# or you can use the melt method associated with a dataframe
# df_wide.melt(id_vars="student", var_name="cLaSs", value_name="gRaDe")
```

This table looks wrong because the `school` column in `df_wide` doesn't belong—`school` should be another identifier column (see Melt 1 above).

## Long data

Create a simple dataframe in long form.

```{python}
df_long = pd.DataFrame(
  {"student": ["Andy", "Bernie", "Cindy", "Deb", "Andy", "Bernie", "Cindy", "Deb", "Andy", "Bernie", "Cindy", "Deb"],
   "school":  ["Z", "Y", "Z", "Y", "Z", "Y", "Z", "Y", "Z", "Y", "Z", "Y"],
   "class":   ["english", "english", "english", "english", "math", "math", "math", "math", "physics", "physics", "physics", "physics"],
   "grade":   [10, 100, 1000, 10000, 20, 200, 2000, 20000, 30, 300, 3000, 30000]
  }
)
df_long
```


##s Long to wide with `pivot_table`

Common terms for this transformation are pivot, spread, dcast. See `pd.pivot_table()` documentation [here](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.pivot_table.html).

We'll use the `pivot_table` method because it's very flexible relative to the `pivot` method (which I won't explain here since `pivot_table` does everything `pivot` can do).

### Pivot 1

Pivot the dataframe by specifying only the index:

```{python}
df_long.pivot_table(index=["student", "school"])
```


```{python}
# same as above
df_long.pivot_table(index=["student", "school"], aggfunc='mean') 
```

```{python}
df_long.pivot_table(index=["student", "school"], aggfunc='sum').reset_index()
```


```{python}
df_long.pivot_table(index=["student", "school"]).reset_index()
```

```{python}
df_long.pivot_table(index=["student", "school"], aggfunc='max').reset_index()
```

```{python}
df_long.pivot_table(index=["student", "school"], aggfunc=['sum', 'last', 'min']).reset_index()
```

```{python}
df_long.pivot_table(index=["student", "school"], columns='class', values='grade').reset_index()
```

```{python}
df_long.pivot_table(index=["student", "school"], columns='class', values='grade', margins=True).reset_index()
```

```{python}
df_long.pivot_table(index="student", columns=['school', 'class'], values='grade').reset_index()
```

```{python}
df_long.pivot_table(index="student", columns=['school', 'class'], values='grade', fill_value=-5)
```

## Resources

https://pbpython.com/pandas-pivot-table-explained.html

https://pandas.pydata.org/pandas-docs/stable/user_guide/reshaping.html

https://chrisalbon.com/python/data_wrangling/pandas_pivot_tables/

https://stackoverflow.com/questions/22798934/pandas-long-to-wide-reshape-by-two-variables
